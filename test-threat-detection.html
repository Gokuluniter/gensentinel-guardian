<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GenSentinel Guardian - Threat Detection Test</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }
        
        .content {
            padding: 30px;
        }
        
        .section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }
        
        .section h2 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.5em;
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 15px;
        }
        
        button {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .btn-primary {
            background: #667eea;
            color: white;
        }
        
        .btn-success {
            background: #10b981;
            color: white;
        }
        
        .btn-warning {
            background: #f59e0b;
            color: white;
        }
        
        .btn-danger {
            background: #ef4444;
            color: white;
        }
        
        .btn-info {
            background: #3b82f6;
            color: white;
        }
        
        .log-container {
            background: #1e293b;
            color: #e2e8f0;
            padding: 20px;
            border-radius: 8px;
            max-height: 500px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            line-height: 1.6;
        }
        
        .log-entry {
            margin-bottom: 10px;
            padding: 8px;
            border-radius: 4px;
        }
        
        .log-success {
            background: rgba(16, 185, 129, 0.1);
            border-left: 3px solid #10b981;
        }
        
        .log-error {
            background: rgba(239, 68, 68, 0.1);
            border-left: 3px solid #ef4444;
        }
        
        .log-info {
            background: rgba(59, 130, 246, 0.1);
            border-left: 3px solid #3b82f6;
        }
        
        .log-warning {
            background: rgba(245, 158, 11, 0.1);
            border-left: 3px solid #f59e0b;
        }
        
        .timestamp {
            color: #94a3b8;
            font-size: 0.85em;
        }
        
        .threat-card {
            background: white;
            border: 2px solid #ef4444;
            border-radius: 10px;
            padding: 15px;
            margin-top: 10px;
        }
        
        .threat-level {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .threat-critical {
            background: #ef4444;
            color: white;
        }
        
        .threat-high {
            background: #f59e0b;
            color: white;
        }
        
        .threat-medium {
            background: #eab308;
            color: white;
        }
        
        .threat-low {
            background: #10b981;
            color: white;
        }
        
        .model-scores {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 15px 0;
        }
        
        .model-score {
            background: #f1f5f9;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        
        .model-score h4 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 0.9em;
        }
        
        .score-value {
            font-size: 2em;
            font-weight: bold;
            color: #1e293b;
        }
        
        .xai-explanation {
            background: #eff6ff;
            border-left: 4px solid #3b82f6;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
        }
        
        .xai-explanation h4 {
            color: #3b82f6;
            margin-bottom: 10px;
        }
        
        .config-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        .config-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }
        
        .config-item label {
            display: block;
            color: #64748b;
            font-size: 0.9em;
            margin-bottom: 5px;
        }
        
        .config-item input {
            width: 100%;
            padding: 8px;
            border: 1px solid #cbd5e1;
            border-radius: 4px;
            font-size: 1em;
        }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-connected {
            background: #10b981;
            animation: pulse 2s infinite;
        }
        
        .status-disconnected {
            background: #ef4444;
        }
        
        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
        }
        
        .clear-btn {
            background: #64748b;
            color: white;
            padding: 8px 16px;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üõ°Ô∏è GenSentinel Guardian</h1>
            <p>AI-Powered Threat Detection Test Suite</p>
            <p style="font-size: 0.9em; margin-top: 10px;">
                <span class="status-indicator" id="statusIndicator"></span>
                <span id="statusText">Initializing...</span>
            </p>
        </div>
        
        <div class="content">
            <!-- Configuration Section -->
            <div class="section">
                <h2>‚öôÔ∏è Configuration</h2>
                <div class="config-section">
                    <div class="config-item">
                        <label>Supabase URL</label>
                        <input type="text" id="supabaseUrl" placeholder="https://your-project.supabase.co">
                    </div>
                    <div class="config-item">
                        <label>Supabase Anon Key</label>
                        <input type="text" id="supabaseKey" placeholder="Your anon key">
                    </div>
                </div>
                <div class="button-group">
                    <button class="btn-primary" onclick="initializeSupabase()">Initialize Connection</button>
                </div>
            </div>
            
            <!-- Test Account Section -->
            <div class="section">
                <h2>üë§ Test Account Setup</h2>
                <p>Create a test user account to perform threat detection testing.</p>
                <div class="button-group">
                    <button class="btn-success" onclick="createTestAccount()">Create New Test Account</button>
                    <button class="btn-info" onclick="loginTestAccount()">Login Existing Test Account</button>
                    <button class="btn-warning" onclick="resetTestAccount()">Reset Test Account Score</button>
                    <button class="btn-danger" onclick="deleteTestAccount()">Delete Test Account</button>
                </div>
                <div id="accountInfo" style="margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px; display: none;">
                    <h4 style="margin-bottom: 10px;">Current Test Account:</h4>
                    <p><strong>Email:</strong> <span id="currentEmail">-</span></p>
                    <p><strong>Employee ID:</strong> <span id="currentEmpId">-</span></p>
                    <p><strong>Security Score:</strong> <span id="currentScore">-</span>/100</p>
                    <p><strong>Organization ID:</strong> <span id="currentOrgId">-</span></p>
                </div>
            </div>
            
            <!-- Normal Activities Section -->
            <div class="section">
                <h2>‚úÖ Normal Activities</h2>
                <p>Perform normal user activities (should result in low threat scores).</p>
                <div class="button-group">
                    <button class="btn-success" onclick="performActivity('login', 'User login activity')">Login</button>
                    <button class="btn-success" onclick="performActivity('document_view', 'Viewed quarterly report')">View Document</button>
                    <button class="btn-success" onclick="performActivity('report_generate', 'Generated monthly report')">Generate Report</button>
                    <button class="btn-success" onclick="performActivity('file_access', 'Accessed project files')">Access Files</button>
                </div>
            </div>
            
            <!-- Suspicious Activities Section -->
            <div class="section">
                <h2>‚ö†Ô∏è Suspicious Activities</h2>
                <p>Perform suspicious activities (should trigger medium to high threat detection).</p>
                <div class="button-group">
                    <button class="btn-warning" onclick="performSuspiciousActivity('unusual_location')">‚ö†Ô∏è Login from Beijing</button>
                    <button class="btn-warning" onclick="performSuspiciousActivity('bulk_download')">‚ö†Ô∏è Bulk Download (139 files)</button>
                    <button class="btn-warning" onclick="performSuspiciousActivity('off_hours_access')">‚ö†Ô∏è Off-Hours File Access</button>
                    <button class="btn-warning" onclick="performSuspiciousActivity('suspicious_file_access')">‚ö†Ô∏è Suspicious File Access</button>
                </div>
            </div>
            
            <!-- Critical Threat Activities Section -->
            <div class="section">
                <h2>üö® Critical Threat Activities</h2>
                <p>Perform critical threat activities (should trigger high/critical threat detection and auto-blocking).</p>
                <div class="button-group">
                    <button class="btn-danger" onclick="performCriticalActivity('data_exfiltration')">üö® Data Exfiltration (1371MB)</button>
                    <button class="btn-danger" onclick="performCriticalActivity('unauthorized_config')">üö® Unauthorized Config Change</button>
                    <button class="btn-danger" onclick="performCriticalActivity('multiple_failed_logins')">üö® 10 Failed Login Attempts</button>
                </div>
            </div>
            
            <!-- View Results Section -->
            <div class="section">
                <h2>üìä View ML Predictions & Results</h2>
                <p>Fetch and display ML threat predictions with ensemble scores and XAI explanations.</p>
                <div class="button-group">
                    <button class="btn-info" onclick="fetchMLPredictions()">Fetch Latest Predictions</button>
                    <button class="btn-info" onclick="fetchSecurityScore()">Check Security Score</button>
                    <button class="clear-btn" onclick="clearLog()">Clear Log</button>
                </div>
            </div>
            
            <!-- Activity Log -->
            <div class="section">
                <h2>üìù Activity Log</h2>
                <div class="log-container" id="logContainer">
                    <div class="log-entry log-info">
                        <span class="timestamp">[System]</span> Ready to begin testing. Please configure Supabase credentials and initialize connection.
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let supabaseClient = null;
        let currentUser = null;
        let testProfileId = null;  // Store the profile ID for queries
        let testOrgId = null;
        let testUserId = 'EMP99999';
        
        // Test account credentials
        const TEST_EMAIL = 'testuser@gensentinel.test';
        const TEST_PASSWORD = 'TestUser@123';
        
        function updateStatus(connected) {
            const indicator = document.getElementById('statusIndicator');
            const text = document.getElementById('statusText');
            
            if (connected) {
                indicator.className = 'status-indicator status-connected';
                text.textContent = 'Connected to Supabase';
            } else {
                indicator.className = 'status-indicator status-disconnected';
                text.textContent = 'Disconnected';
            }
        }
        
        async function initializeSupabase() {
            const url = document.getElementById('supabaseUrl').value.trim();
            const key = document.getElementById('supabaseKey').value.trim();
            
            if (!url || !key) {
                logError('‚ùå Please enter both Supabase URL and Anon Key');
                return;
            }
            
            // Validate URL format
            if (!url.startsWith('https://') || !url.includes('supabase.co')) {
                logError('‚ùå Invalid Supabase URL format. Should be: https://xxx.supabase.co');
                return;
            }
            
            try {
                logInfo('Testing connection to Supabase...');
                supabaseClient = supabase.createClient(url, key);
                
                // Test the connection
                const { error: testError } = await supabaseClient.from('organizations').select('count').limit(1);
                
                if (testError && testError.message.includes('Failed to fetch')) {
                    throw new Error('Cannot connect to Supabase. Please check:\n1. Your internet connection\n2. Supabase URL is correct\n3. Supabase project is running');
                }
                
                updateStatus(true);
                logSuccess('‚úÖ Supabase client initialized successfully');
                logSuccess('‚úÖ Connection test passed');
                logInfo('Ready to create test account and perform activities');
            } catch (error) {
                logError('Failed to initialize Supabase: ' + error.message);
                updateStatus(false);
                
                // Provide helpful troubleshooting
                logWarning('Troubleshooting tips:');
                logInfo('1. Check your internet connection');
                logInfo('2. Verify Supabase URL format: https://xxx.supabase.co');
                logInfo('3. Verify Supabase Anon Key is correct');
                logInfo('4. Check if Supabase project is running');
                logInfo('5. Check browser console (F12) for more details');
            }
        }
        
        async function createTestAccount() {
            if (!supabaseClient) {
                logError('‚ùå Please initialize Supabase connection first');
                logInfo('üëâ Click "Initialize Connection" button above');
                return;
            }
            
            logInfo('üîÑ Creating test account...');
            
            try {
                // Create organization first
                logInfo('Step 1: Creating test organization...');
                const { data: org, error: orgError } = await supabaseClient
                    .from('organizations')
                    .insert({
                        name: 'Test Organization',
                        industry: 'Technology',
                        company_size: 'small',
                        primary_contact_email: TEST_EMAIL,
                        primary_contact_name: 'Test User',
                        primary_contact_phone: '+1234567890'
                    })
                    .select()
                    .single();
                
                if (orgError) {
                    // Check for connection issues
                    if (orgError.message.includes('Failed to fetch')) {
                        throw new Error('Network error: Cannot reach Supabase. Check your internet connection.');
                    }
                    
                    // Organization might already exist, try to fetch it
                    logInfo('Organization might already exist, checking...');
                    const { data: existingOrg, error: fetchError } = await supabaseClient
                        .from('organizations')
                        .select('*')
                        .eq('name', 'Test Organization')
                        .limit(1)
                        .single();
                    
                    if (fetchError && fetchError.message.includes('Failed to fetch')) {
                        throw new Error('Network error: Cannot reach Supabase. Check your internet connection.');
                    }
                    
                    if (existingOrg) {
                        testOrgId = existingOrg.id;
                        logSuccess('‚úÖ Using existing test organization: ' + testOrgId);
                    } else {
                        throw new Error('Cannot create or find organization: ' + orgError.message);
                    }
                } else {
                    testOrgId = org.id;
                    logSuccess('‚úÖ Created test organization: ' + testOrgId);
                }
                
                // Sign up user
                logInfo('Step 2: Creating test user account...');
                const { data: authData, error: authError } = await supabaseClient.auth.signUp({
                    email: TEST_EMAIL,
                    password: TEST_PASSWORD,
                    options: {
                        emailRedirectTo: window.location.origin,
                        data: {
                            first_name: 'Test',
                            last_name: 'User',
                            employee_id: testUserId,
                            organization_id: testOrgId,
                            department: 'IT Security',
                            role: 'user'
                        }
                    }
                });
                
                if (authError) {
                    if (authError.message.includes('Failed to fetch')) {
                        throw new Error('Network error: Cannot reach Supabase authentication service.');
                    }
                    if (authError.message.includes('already registered')) {
                        logWarning('‚ö†Ô∏è Test account already exists, attempting to login...');
                        await loginTestAccount();
                        return;
                    }
                    throw authError;
                }
                
                currentUser = authData.user;
                logSuccess('‚úÖ Test account created in auth!');
                logInfo('User ID: ' + currentUser.id);
                
                // Check if profile was auto-created
                logInfo('Step 3: Checking/creating profile...');
                const { data: existingProfile, error: profileCheckError } = await supabaseClient
                    .from('profiles')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .single();
                
                if (!existingProfile) {
                    // Profile not created automatically, create it manually
                    logInfo('Creating profile manually...');
                    const { data: newProfile, error: profileInsertError } = await supabaseClient
                        .from('profiles')
                        .insert({
                            user_id: currentUser.id,
                            email: TEST_EMAIL,
                            first_name: 'Test',
                            last_name: 'User',
                            employee_id: testUserId,
                            department: 'hr',  // Using enum value
                            organization_id: testOrgId,
                            role: 'user',
                            security_score: 100,
                            is_active: true
                        })
                        .select()
                        .single();
                    
                    if (profileInsertError) {
                        throw new Error('Failed to create profile: ' + profileInsertError.message);
                    }
                    
                    logSuccess('‚úÖ Profile created manually');
                } else {
                    logSuccess('‚úÖ Profile already exists');
                    
                    // Update profile with additional info
                    logInfo('Updating profile with test data...');
                    const { error: updateError } = await supabaseClient
                        .from('profiles')
                        .update({
                            employee_id: testUserId,
                            department: 'hr',
                            organization_id: testOrgId,
                            security_score: 100
                        })
                        .eq('user_id', currentUser.id);
                    
                    if (updateError) {
                        logWarning('Profile update warning: ' + updateError.message);
                    } else {
                        logSuccess('‚úÖ Profile updated');
                    }
                }
                
                logSuccess('‚úÖ Test account created successfully!');
                logSuccess('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
                logInfo('üìß Email: ' + TEST_EMAIL);
                logInfo('üîë Password: ' + TEST_PASSWORD);
                logInfo('üë§ User ID: ' + currentUser.id);
                logInfo('üÜî Employee ID: ' + testUserId);
                logInfo('üè¢ Organization ID: ' + testOrgId);
                logSuccess('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
                logSuccess('üéâ Account setup complete! You can now perform test activities.');
                
            } catch (error) {
                logError('‚ùå Failed to create test account: ' + error.message);
                
                // Provide specific troubleshooting
                if (error.message.includes('Network') || error.message.includes('fetch')) {
                    logError('');
                    logError('üîß Troubleshooting Steps:');
                    logInfo('1. Check your internet connection');
                    logInfo('2. Verify Supabase project is running');
                    logInfo('3. Check Supabase Dashboard for service status');
                    logInfo('4. Try refreshing the page and reconnecting');
                    logInfo('5. Open browser console (F12) for detailed error');
                } else if (error.message.includes('JWT') || error.message.includes('token')) {
                    logError('');
                    logError('üîß Authentication Issue:');
                    logInfo('1. Verify your Supabase Anon Key is correct');
                    logInfo('2. Check if auth is enabled in Supabase');
                    logInfo('3. Try using a fresh Anon Key from Supabase Dashboard');
                }
            }
        }
        
        async function loginTestAccount() {
            if (!supabaseClient) {
                logError('Please initialize Supabase connection first');
                return;
            }
            
            logInfo('Logging in with test account...');
            
            try {
                const { data, error } = await supabaseClient.auth.signInWithPassword({
                    email: TEST_EMAIL,
                    password: TEST_PASSWORD
                });
                
                if (error) throw error;
                
                currentUser = data.user;
                logSuccess('‚úÖ Authentication successful!');
                logInfo('User ID: ' + currentUser.id);
                
                // Get profile data with timeout
                logInfo('Fetching profile data...');
                
                const { data: profile, error: profileError } = await supabaseClient
                    .from('profiles')
                    .select('id, employee_id, organization_id, security_score, email')
                    .eq('user_id', currentUser.id)
                    .single();
                
                if (profileError) {
                    logWarning('Could not fetch profile: ' + profileError.message);
                    logInfo('You can still perform activities with this account');
                    testUserId = 'EMP99999';
                    return;
                }
                
                if (profile) {
                    testProfileId = profile.id;  // Store profile ID
                    testOrgId = profile.organization_id;
                    testUserId = profile.employee_id || 'EMP99999';
                    
                    logSuccess('‚úÖ Logged in successfully!');
                    logSuccess('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
                    logInfo('üìß Email: ' + TEST_EMAIL);
                    logInfo('üë§ User ID: ' + currentUser.id);
                    logInfo('üÜî Profile ID: ' + testProfileId);
                    logInfo('üÜî Employee ID: ' + testUserId);
                    logInfo('üè¢ Organization ID: ' + testOrgId);
                    logInfo('üìä Security Score: ' + (profile.security_score || 100));
                    logSuccess('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
                    logSuccess('üéâ Ready to perform test activities!');
                }
                
            } catch (error) {
                logError('Failed to login: ' + error.message);
                logError('Please check if the account exists or try creating it again');
            }
        }
        
        // Reset Test Account Score to 100
        async function resetTestAccount() {
            if (!supabaseClient) {
                logError('‚ùå Please initialize Supabase connection first');
                return;
            }
            
            if (!confirm('Reset test account security score to 100?')) {
                return;
            }
            
            logInfo('üîÑ Resetting test account score...');
            
            try {
                const { data: profiles, error: findError } = await supabaseClient
                    .from('profiles')
                    .select('*')
                    .eq('email', TEST_EMAIL)
                    .limit(1);
                
                if (findError) throw findError;
                
                if (!profiles || profiles.length === 0) {
                    logError('‚ùå Test account not found. Please create one first.');
                    return;
                }
                
                const profile = profiles[0];
                
                const { error: updateError } = await supabaseClient
                    .from('profiles')
                    .update({
                        security_score: 100,
                        last_score_update: new Date().toISOString()
                    })
                    .eq('id', profile.id);
                
                if (updateError) throw updateError;
                
                // Clear notifications
                await supabaseClient
                    .from('security_notifications')
                    .delete()
                    .eq('profile_id', profile.id);
                
                logSuccess('‚úÖ Test account score reset to 100!');
                logSuccess('‚úÖ All notifications cleared!');
                logInfo('You can now login and perform fresh activities.');
                
            } catch (error) {
                logError('Failed to reset account: ' + error.message);
            }
        }
        
        // Delete Test Account
        async function deleteTestAccount() {
            if (!supabaseClient) {
                logError('‚ùå Please initialize Supabase connection first');
                return;
            }
            
            if (!confirm('‚ö†Ô∏è WARNING: This will permanently delete the test account and all its data. Continue?')) {
                return;
            }
            
            logInfo('üóëÔ∏è Deleting test account...');
            
            try {
                // First, find the profile
                const { data: profiles, error: findError } = await supabaseClient
                    .from('profiles')
                    .select('*')
                    .eq('email', TEST_EMAIL)
                    .limit(1);
                
                if (findError) throw findError;
                
                if (!profiles || profiles.length === 0) {
                    logWarning('‚ö†Ô∏è Test account not found.');
                    return;
                }
                
                const profile = profiles[0];
                
                logInfo('Deleting related data...');
                
                // Delete related data (cascading deletes should handle most of this)
                await supabaseClient.from('activity_logs').delete().eq('user_id', profile.id);
                await supabaseClient.from('ml_threat_predictions').delete().eq('profile_id', profile.id);
                await supabaseClient.from('threat_detections').delete().eq('user_id', profile.id);
                await supabaseClient.from('security_notifications').delete().eq('profile_id', profile.id);
                await supabaseClient.from('security_score_history').delete().eq('profile_id', profile.id);
                
                // Delete the profile
                const { error: deleteError } = await supabaseClient
                    .from('profiles')
                    .delete()
                    .eq('id', profile.id);
                
                if (deleteError) throw deleteError;
                
                // Sign out if currently logged in
                if (currentUser) {
                    await supabaseClient.auth.signOut();
                    currentUser = null;
                    testProfileId = null;
                    testOrgId = null;
                    testUserId = 'EMP99999';
                }
                
                logSuccess('‚úÖ Test account and all related data deleted successfully!');
                logInfo('You can now create a fresh test account.');
                
            } catch (error) {
                logError('Failed to delete account: ' + error.message);
                logError('Some data may remain. Try again or contact administrator.');
            }
        }
        
        async function performActivity(activityType, description) {
            if (!currentUser || !testOrgId) {
                logError('Please create and login to test account first');
                return;
            }
            
            logInfo(`Performing activity: ${activityType} - ${description}`);
            
            try {
                const url = document.getElementById('supabaseUrl').value;
                const key = document.getElementById('supabaseKey').value;
                
                const response = await fetch(`${url}/functions/v1/ingest-activity`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${key}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        organization_id: testOrgId,
                        user_id: testUserId,
                        activity_type: activityType,
                        description: description,
                        metadata: {
                            ip_address: activityType.includes('Beijing') ? '203.45.67.9' : '192.168.1.100',
                            country: activityType.includes('Beijing') ? 'CN' : 'IN',
                            city: activityType.includes('Beijing') ? 'Beijing' : 'Chennai',
                            user_agent: 'Mozilla/5.0 (Test Browser)',
                            file_count: activityType === 'data_export' ? 232 : (activityType === 'document_view' ? 1 : 0),
                            data_volume_mb: activityType === 'data_export' ? 1371.87 : (activityType === 'document_view' ? 2.5 : 0),
                            failed_attempts: 0,
                            is_new_ip: activityType.includes('Beijing') ? 1 : 0,
                            time_since_last_activity_minutes: Math.floor(Math.random() * 60)
                        },
                        timestamp: new Date().toISOString()
                    })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    logSuccess('‚úÖ Activity logged successfully');
                    
                    // Log the full response for debugging
                    console.log('Activity response:', result);
                    
                    // Check for ML prediction in response
                    if (result.ml_prediction || result.mlPrediction) {
                        const mlPred = result.ml_prediction || result.mlPrediction;
                        logSuccess('ü§ñ ML Prediction received!');
                        displayMLPrediction(mlPred);
                    } else if (result.threat_analysis) {
                        logInfo('üìä Threat Analysis: ' + JSON.stringify(result.threat_analysis));
                    }
                    
                    // Show score change
                    if (result.score_impact !== undefined) {
                        const scoreChange = result.score_impact > 0 ? '+' + result.score_impact : result.score_impact;
                        logInfo(`üìä Security Score: ${result.previous_score} ‚Üí ${result.security_score} (${scoreChange})`);
                    }
                } else {
                    logError('Failed to log activity: ' + (result.error || 'Unknown error'));
                }
                
            } catch (error) {
                logError('Error performing activity: ' + error.message);
            }
        }
        
        async function performSuspiciousActivity(threatType) {
            const activities = {
                'unusual_location': {
                    type: 'login',
                    description: 'THREAT: Unusual Location',
                    metadata: {
                        ip_address: '203.45.67.9',
                        country: 'CN',
                        city: 'Beijing',
                        file_count: 9,
                        data_volume_mb: 77.43,
                        failed_attempts: 0,
                        is_new_ip: 1,
                        time_since_last_activity_minutes: 971
                    }
                },
                'bulk_download': {
                    type: 'file_download',
                    description: 'THREAT: Bulk Download',
                    metadata: {
                        ip_address: '192.168.1.15',
                        country: 'IN',
                        city: 'Chennai',
                        file_count: 139,
                        data_volume_mb: 682.49,
                        failed_attempts: 0,
                        is_new_ip: 0,
                        time_since_last_activity_minutes: 154
                    }
                },
                'off_hours_access': {
                    type: 'file_download',
                    description: 'THREAT: Off Hours Access',
                    metadata: {
                        ip_address: '10.0.0.18',
                        country: 'IN',
                        city: 'Chennai',
                        file_count: 10,
                        data_volume_mb: 22.09,
                        failed_attempts: 0,
                        is_new_ip: 0,
                        time_since_last_activity_minutes: 479
                    }
                },
                'suspicious_file_access': {
                    type: 'file_access',
                    description: 'THREAT: Suspicious File Access',
                    metadata: {
                        ip_address: '192.168.1.15',
                        country: 'IN',
                        city: 'Chennai',
                        file_count: 20,
                        data_volume_mb: 33.65,
                        failed_attempts: 0,
                        is_new_ip: 0,
                        time_since_last_activity_minutes: 270
                    }
                }
            };
            
            const activity = activities[threatType];
            if (!activity) {
                logError('Unknown suspicious activity type');
                return;
            }
            
            logWarning(`‚ö†Ô∏è Performing suspicious activity: ${threatType}`);
            await performActivity(activity.type, activity.description);
        }
        
        async function performCriticalActivity(threatType) {
            const activities = {
                'data_exfiltration': {
                    type: 'data_export',
                    description: 'CRITICAL THREAT: Large data export to external location - 1371MB',
                    metadata: {
                        ip_address: '203.45.67.10',
                        country: 'CN',
                        city: 'Beijing',
                        file_count: 232,
                        data_volume_mb: 1371.87,
                        failed_attempts: 0,
                        is_new_ip: 1,
                        time_since_last_activity_minutes: 309
                    }
                },
                'unauthorized_config': {
                    type: 'system_config',
                    description: 'THREAT: Unauthorized Config Change',
                    metadata: {
                        ip_address: '192.168.1.4',
                        country: 'IN',
                        city: 'Chennai',
                        file_count: 0,
                        data_volume_mb: 0,
                        failed_attempts: 0,
                        is_new_ip: 0,
                        time_since_last_activity_minutes: 374
                    }
                },
                'multiple_failed_logins': {
                    type: 'login',
                    description: 'THREAT: Multiple Failed Logins',
                    metadata: {
                        ip_address: '203.45.67.17',
                        country: 'IN',
                        city: 'Chennai',
                        file_count: 0,
                        data_volume_mb: 0,
                        failed_attempts: 10,
                        is_new_ip: 1,
                        time_since_last_activity_minutes: 627
                    }
                }
            };
            
            const activity = activities[threatType];
            if (!activity) {
                logError('Unknown critical activity type');
                return;
            }
            
            logError(`üö® Performing critical threat activity: ${threatType}`);
            await performActivity(activity.type, activity.description);
        }
        
        async function fetchMLPredictions() {
            if (!testProfileId) {
                logError('Please login first');
                return;
            }
            
            logInfo('Fetching latest ML predictions...');
            
            try {
                const { data, error } = await supabaseClient
                    .from('ml_threat_predictions')
                    .select('*')
                    .eq('profile_id', testProfileId)
                    .order('created_at', { ascending: false })
                    .limit(10);
                
                if (error) throw error;
                
                if (data && data.length > 0) {
                    logSuccess(`‚úÖ Found ${data.length} ML predictions:`);
                    data.forEach(prediction => {
                        displayMLPrediction(prediction);
                    });
                } else {
                    logInfo('No ML predictions found yet. Perform some activities first.');
                }
                
            } catch (error) {
                logError('Error fetching predictions: ' + error.message);
            }
        }
        
        async function fetchSecurityScore() {
            if (!testProfileId) {
                logError('Please login first');
                return;
            }
            
            logInfo('Fetching current security score...');
            
            try {
                const { data, error } = await supabaseClient
                    .from('profiles')
                    .select('security_score, updated_at')
                    .eq('id', testProfileId)
                    .single();
                
                if (error) throw error;
                
                const score = data.security_score || 100;
                const scoreClass = score >= 80 ? 'log-success' : score >= 50 ? 'log-warning' : 'log-error';
                
                logCustom(`üìä Security Score: ${score}/100`, scoreClass);
                logInfo('Last updated: ' + new Date(data.updated_at).toLocaleString());
                
            } catch (error) {
                logError('Error fetching security score: ' + error.message);
            }
        }
        
        function displayMLPrediction(prediction) {
            const container = document.getElementById('logContainer');
            
            const threatCard = document.createElement('div');
            threatCard.className = 'threat-card';
            
            const levelClass = `threat-${prediction.threat_level || 'low'}`;
            const levelText = (prediction.threat_level || 'low').toUpperCase();
            
            threatCard.innerHTML = `
                <div class="threat-level ${levelClass}">${levelText} THREAT</div>
                <p><strong>Threat Probability:</strong> ${(prediction.threat_probability * 100).toFixed(2)}%</p>
                <p><strong>Threat Class:</strong> ${prediction.threat_class}</p>
                <p><strong>Threat Type:</strong> ${prediction.threat_type || 'N/A'}</p>
                <p><strong>Confidence:</strong> ${(prediction.prediction_confidence * 100).toFixed(2)}%</p>
                <p><strong>Auto-blocked:</strong> ${prediction.auto_blocked ? 'üö´ YES' : '‚úÖ NO'}</p>
                
                <div class="model-scores">
                    <div class="model-score">
                        <h4>ü§ñ Supervised Model</h4>
                        <div class="score-value">${((prediction.supervised_prediction || 0) * 100).toFixed(1)}%</div>
                        <small>${prediction.supervised_model_version || 'v1.0'}</small>
                    </div>
                    <div class="model-score">
                        <h4>üéØ Isolation Forest</h4>
                        <div class="score-value">${((prediction.anomaly_score || 0) * 100).toFixed(1)}%</div>
                        <small>${prediction.isolation_forest_version || 'v1.0'}</small>
                    </div>
                    <div class="model-score">
                        <h4>üîÑ LSTM Autoencoder</h4>
                        <div class="score-value">${((prediction.sequence_anomaly_score || 0) * 100).toFixed(1)}%</div>
                        <small>${prediction.lstm_model_version || 'v1.0'}</small>
                    </div>
                    <div class="model-score">
                        <h4>üé≤ Ensemble Score</h4>
                        <div class="score-value" style="color: #ef4444;">${(prediction.threat_probability * 100).toFixed(1)}%</div>
                        <small>Combined Result</small>
                    </div>
                </div>
                
                ${prediction.xai_explanation ? `
                    <div class="xai-explanation">
                        <h4>üí° AI Explanation</h4>
                        <p>${prediction.xai_explanation}</p>
                    </div>
                ` : ''}
                
                <p style="margin-top: 15px; color: #64748b; font-size: 0.9em;">
                    <strong>Time:</strong> ${new Date(prediction.created_at).toLocaleString()}
                </p>
            `;
            
            container.insertBefore(threatCard, container.firstChild);
            
            logSuccess('üéØ ML Prediction displayed above');
        }
        
        function log(message, type = 'info') {
            const container = document.getElementById('logContainer');
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            
            const timestamp = new Date().toLocaleTimeString();
            entry.innerHTML = `<span class="timestamp">[${timestamp}]</span> ${message}`;
            
            container.appendChild(entry);
            container.scrollTop = container.scrollHeight;
        }
        
        function logSuccess(message) {
            log(message, 'success');
        }
        
        function logError(message) {
            log(message, 'error');
        }
        
        function logWarning(message) {
            log(message, 'warning');
        }
        
        function logInfo(message) {
            log(message, 'info');
        }
        
        function logCustom(message, className) {
            const container = document.getElementById('logContainer');
            const entry = document.createElement('div');
            entry.className = `log-entry ${className}`;
            
            const timestamp = new Date().toLocaleTimeString();
            entry.innerHTML = `<span class="timestamp">[${timestamp}]</span> ${message}`;
            
            container.appendChild(entry);
            container.scrollTop = container.scrollHeight;
        }
        
        function clearLog() {
            const container = document.getElementById('logContainer');
            container.innerHTML = '<div class="log-entry log-info"><span class="timestamp">[System]</span> Log cleared.</div>';
        }
    </script>
</body>
</html>

